{% extends 'base.html' %}
{% block content %}
<script>
    $(document).ready(function () {

        var context = document.getElementById('today_dection').getContext('2d');
        var myChart = new Chart(context, {
            type: 'bar',
            data: {
                labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23'],
                datasets: [{
                    label: '탐지수',
                    fill: false,
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 5, 10, 13, 3, 4, 10, 16, 20, 30, 47, 10, 8, 7, 5, 100],
                    backgroundColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(59, 130, 246, 1)',


                    ],
                    // borderColor: ['rgba(255, 99, 132, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                title: {
                    display: true,
                    text: '금일탐지건수',
                    fontSize: 18,
                    align: 'left',

                },
                elements: {
                    point: {
                        radius: 0,
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: '금일탐지건수',
                        align: 'left',
                    }
                }

            }

        });


        var context = document.getElementById('storage').getContext('2d');
        var myChart = new Chart(context, {
            type: 'doughnut',
            data: {
                labels: ['100'],
                datasets: [{
                    label: '스토리지 가용량',
                    fill: false,
                    data: [100-50],
                    backgroundColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(59, 5, 246, 1)',
                    ],
                    // borderColor: ['rgba(255, 99, 132, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                    rotation: 1 * Math.PI,
                    circumference: 1 * Math.PI,


                title: {
                    display: true,
                    text: '스토리지 가용량',
                    fontSize: 18,
                    align: 'left',
                },
                elements: {
                    point: {
                        radius: 0,
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: '금일탐지건수'
                    }
                }
            }
        });

        var context = document.getElementById('DB_storage').getContext('2d');
        var myChart = new Chart(context, {
            type: 'doughnut',
            data: {
                labels: ['100'],
                datasets: [{
                    label: '스토리지 가용량',
                    fill: false,
                    data: [50],
                    backgroundColor: [

                    ],
                    // borderColor: ['rgba(255, 99, 132, 1)'],
                    borderWidth: 1
                }]
            },
            options: {

                rotation: 1 * Math.PI,
                circumference: 1 * Math.PI,

                title: {
                    display: true,
                    text: 'DB스토리지 가용량',
                    fontSize: 18,
                    align: 'left',
                },
                elements: {
                    point: {
                        radius: 0,
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'DB스토리지 가용량'
                    }
                }
            }
        });

        var context = document.getElementById('CPU_usage').getContext('2d');
        var myChart = new Chart(context, {
            type: 'doughnut',
            data: {
                labels: ['100'],
                datasets: [{
                    label: 'CPU 사용량',
                    fill: false,
                    data: [50],
                    backgroundColor: [

                    ],
                    // borderColor: ['rgba(255, 99, 132, 1)'],
                    borderWidth: 1
                }]
            },
            options: {

                rotation: 1 * Math.PI,
                circumference: 1 * Math.PI,

                title: {
                    display: true,
                    text: 'CPU 사용량',
                    fontSize: 18,
                    align: 'left',
                },
                elements: {
                    point: {
                        radius: 0,
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'CPU 사용량'
                    }
                }
            }
        });

        var context = document.getElementById('network_traffic').getContext('2d');
        var myChart = new Chart(context, {
            type: 'doughnut',
            data: {
                labels: [''],
                datasets: [{
                    label: 'network_traffic',
                    fill: false,
                    data: [70],
                    backgroundColor: [

                    ],
                    // borderColor: ['rgba(255, 99, 132, 1)'],
                    borderWidth: 1
                }]
            },
            options: {

                rotation: 1 * Math.PI,
                circumference: 1 * Math.PI,
                title: {
                    display: true,
                    text: 'network_traffic',
                    fontSize: 18,
                    align: 'left',
                },
                elements: {
                    point: {
                        radius: 0,
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'network_traffic'
                    }
                }
            }
        });

        function updateData() {
            $.ajax({
                url: "{% url 'main:get_updated_data' %}",
                type: 'POST',
                headers: { "X-CSRFToken": '{{csrf_token}}' },
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function (response) {
                    document.getElementById('dect_count').textContent = response.dect_count + "건";
                    document.getElementById('report_count').textContent = response.report_count + "건";
                    document.getElementById('report_done_count').textContent = response.report_done_count + "건";

                    document.getElementById('dect-table-caption').textContent = '미처리 탐지건수(' + response.dect_count + '건)';
                    document.getElementById('report-table-caption').textContent = '사유서 미처리 탐지건수(' + response.report_count + '건)';

                    const dect_tableBody = document.getElementById("dect-table-body");
                    replaceTable(response.dection_list, dect_tableBody);

                    const report_tableBody = document.getElementById("report-table-body");
                    replaceTable(response.report_list, report_tableBody);
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        }
        //setInterval(updateData, 10000);

        function replaceTable(lists, tableBody) {
            tableBody.innerHTML = "";
            lists.forEach((list) => {
                const newRow = document.createElement("tr");

                const dectNoCell = document.createElement("td");
                dectNoCell.textContent = list.dect_no;
                newRow.appendChild(dectNoCell);

                const createAtCell = document.createElement("td");
                createAtCell.textContent = convertToLocalTime(list.create_at);
                newRow.appendChild(createAtCell);

                const ipCell = document.createElement("td");
                ipCell.textContent = list.ip;
                newRow.appendChild(ipCell);

                const empNameCell = document.createElement("td");
                empNameCell.textContent = list.emp_no__emp_name;
                newRow.appendChild(empNameCell);

                const depmtNameCell = document.createElement("td");
                depmtNameCell.textContent = list.emp_no__depmt_no__depmt_name;
                newRow.appendChild(depmtNameCell);

                const statusCell = document.createElement("td");
                statusCell.textContent = "미처리";
                newRow.appendChild(statusCell);

                const remarkCell = document.createElement("td");
                const processButton = document.createElement("button");
                processButton.className = "btn btn-primary";
                processButton.textContent = "처리하기";

                processButton.addEventListener("click", process);

                remarkCell.appendChild(processButton);
                newRow.appendChild(remarkCell);
                tableBody.appendChild(newRow);
            });
        }

        function convertToLocalTime(utcDateString) {
            var date = new Date(utcDateString);

            var year = date.getUTCFullYear();
            var month = date.getUTCMonth() + 1;
            var day = date.getUTCDate();
            var hours = date.getUTCHours();
            var minutes = date.getUTCMinutes();

            var period = hours >= 12 ? '오후' : '오전';
            hours = hours % 12;
            hours = hours ? hours : 12;

            var formattedDateTime = year + '년 ' + month + '월 ' + day + '일 ' + hours + ':' + ('0' + minutes).slice(-2) + ' ' + period;
            return formattedDateTime;
        }

var context = document.getElementById('CPU_usage').getContext('2d');
var myChart = new Chart(context, {
    type: 'doughnut',
    data: {
        labels: ['100'],
        datasets: [{
            label: 'CPU 사용량',
            fill: false,
            data: [50],
            backgroundColor: [

            ],
            // borderColor: ['rgba(255, 99, 132, 1)'],
            borderWidth: 1
        }]
    },
    options: {
        
        rotation: -90,
        circumference: 180,
        title: { 
            display: true,
            text: 'CPU 사용량',
            fontSize: 18,
            align: 'left',
        },
        elements: {
            point: {
                radius: 0,
            }
        },
        plugins: {
            title: {
                display: true,
                text: 'CPU 사용량'
            }
        }
    }
});

var context = document.getElementById('network_traffic').getContext('2d');
var myChart = new Chart(context, {
    type: 'doughnut',
    data: {
        labels: ['100'],
        datasets: [{
            label: 'network_traffic',
            fill: false,
            data: [50],
            backgroundColor: [

            ],
            // borderColor: ['rgba(255, 99, 132, 1)'],
            borderWidth: 1
        }]
    },
    options: {
        
        rotation: -90,
        circumference: 180,
        title: { 
            display: true,
            text: 'network_traffic',
            fontSize: 18,
            align: 'left',
        },
        elements: {
            point: {
                radius: 0,
            }
        },
        plugins: {
            title: {
                display: true,
                text: 'network_traffic'
            }
        }
    }
});

function updateData() {
    $.ajax({
        url: "{% url 'main:get_updated_data' %}",
        type: 'POST',
        headers: { "X-CSRFToken": '{{csrf_token}}' },
        processData: false, 
        contentType: false,
        dataType: 'json',
        success: function(response) {
            document.getElementById('dect_count').textContent = response.dect_count + "건";
            document.getElementById('report_count').textContent = response.report_count + "건";
            document.getElementById('report_done_count').textContent = response.report_done_count + "건";

            document.getElementById('dect-table-caption').textContent = '미처리 탐지건수(' + response.dect_count + '건)';
            document.getElementById('report-table-caption').textContent = '사유서 미처리 탐지건수(' + response.report_count + '건)';

            const dect_tableBody = document.getElementById("dect-table-body");
            replaceTable(response.dection_list, dect_tableBody);
        
            const report_tableBody = document.getElementById("report-table-body");
            replaceTable(response.report_list, report_tableBody);
        },
        error : function(error) {
            console.error(error);
        }
    });
}
setInterval(updateData, 10000);

function replaceTable(lists, tableBody){
    tableBody.innerHTML = "";
    lists.forEach((list) => {
        const newRow = document.createElement("tr");

        const dectNoCell = document.createElement("td");
        dectNoCell.textContent = list.dect_no;
        newRow.appendChild(dectNoCell);

        const createAtCell = document.createElement("td");
        createAtCell.textContent = convertToLocalTime(list.create_at);
        newRow.appendChild(createAtCell);

        const ipCell = document.createElement("td");
        ipCell.textContent = list.ip;
        newRow.appendChild(ipCell);

        const empNameCell = document.createElement("td");
        empNameCell.textContent = list.emp_no__emp_name;
        newRow.appendChild(empNameCell);

        const depmtNameCell = document.createElement("td");
        depmtNameCell.textContent = list.emp_no__depmt_no__depmt_name;
        newRow.appendChild(depmtNameCell);

        const statusCell = document.createElement("td");
        statusCell.textContent = "미처리";
        newRow.appendChild(statusCell);

        const remarkCell = document.createElement("td");
        const processButton = document.createElement("button");
        processButton.className = "btn btn-outline-primary";
        processButton.textContent = "처리하기";

        processButton.addEventListener("click", process);

        remarkCell.appendChild(processButton);
        newRow.appendChild(remarkCell);
        tableBody.appendChild(newRow);
    });
}

function convertToLocalTime(utcDateString) {
    var date = new Date(utcDateString);

    var year = date.getUTCFullYear();
    var month = date.getUTCMonth() + 1;
    var day = date.getUTCDate();
    var hours = date.getUTCHours();
    var minutes = date.getUTCMinutes();

    var period = hours >= 12 ? '오후' : '오전';
    hours = hours % 12;
    hours = hours ? hours : 12;
    
    var formattedDateTime = year + '년 ' + month + '월 ' + day + '일 ' + hours + ':' + ('0' + minutes).slice(-2) + ' ' + period;
    return formattedDateTime;
}

});

function process(dect_no){
    const url = "/" + dect_no + "/process/";
    window.location.href = url;
}
</script>

<div class="container-fluid" style="margin-top: 50px; margin-left: 25px;">
        <div class="col-6">
            <div class="row">
                <div class="col-4" style="text-align: left; font-size: 14px;">
                    <div class="item col-2 shadow p-3 mb-5 bg-body rounded w-100">
                        사유서 처리 대기
                        <div id="report_count" style="text-align: right; font-size: 32px; color: #FCD34D;">{{report_count}}건</div>
                    </div>   
                </div>
                
                <div class="col-4" style="text-align: left; font-size: 14px;">
                    <div class="item col-2 shadow p-3 mb-5 bg-body rounded w-100">
                        처리 완료
                        <div id="report_done_count" style="text-align: right; font-size: 32px; color: #3B82F6;">{{report_done_count}}건</div>
                    </div>    
                </div>
        
                <div class="col-4" style="text-align: left; font-size: 14px;">
                    <div class="item col-2 shadow p-3 mb-5 bg-body rounded w-100">미처리
                        <div id="dect_count" style="text-align: right; font-size: 32px; color: #DC2626;">{{dect_count}}건</div>
                    </div> 
                </div>
                <div style="margin-top: 50px;">
                    <canvas id="today_dection"></canvas>
                </div>
                <div class="container-fluid">
                    <div class="col-6">
                        <div style="height: 150px; width: 150px; margin-top: 50px;">
                            <canvas id="storage"></canvas>
                            <canvas id="DB_storage"></canvas>

<div class="container2" style="display: flex; margin-left: 48px; margin-right: 48px;">

    <div class="row" >
        <div class="row-4" style="font-weight: bold;">
            <div style="font-size: 20px; margin-top: 20px;margin-bottom: 20px ;">실시간 처리 현황</div>
            <div class="row-4">
                <div class="row">
                    <div class="col-4" style="text-align: left; font-size: 14px;">
                        <div class="item col-2 shadow p-3 mb-5 bg-body rounded w-100" style="
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: right;
  padding: 24px;
  gap: 40px;

  position: static;
  width: 100%;
  max-width: 284px;
  height: 148px;
  left: 48px;
  top: 188px;

  background: #FFFFFF;
  border-radius: 8px;
">
                            사유서 처리 대기
                            <div id="report_done_count" style="text-align: right; font-size: 32px; color: #FCD34D;">
                                {{report_count}}건</div>
                        </div>
                    </div>

                    <div class="col-4" style="text-align: left; font-size: 14px;">
                        <div class="item col-2 shadow p-3 mb-5 bg-body rounded w-100" style="
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: right;
  padding: 24px;
  gap: 40px;

  position: static;
  width: 100%;
  max-width: 284px;
  height: 148px;
  left: 48px;
  top: 188px;

  background: #FFFFFF;
  border-radius: 8px;
">
                            처리 완료
                            <div id="report_done_count" style="text-align: right; font-size: 32px; color: #DC2626;">
                                {{report_done_count}}건</div>
                        </div>
                    </div>

                    <div class="col-4" style="text-align: left; font-size: 14px;">
                        <div class="item col-2 shadow p-3 mb-5 bg-body rounded w-100" style="
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: right;
  padding: 24px;
  gap: 40px;

  position: static;
  width: 100%;
  max-width: 284px;
  height: 148px;
  left: 48px;
  top: 188px;

  background: #FFFFFF;
  border-radius: 8px;
">
                            미처리
                            <div id="dect_count" style="text-align: right; font-size: 32px; color: #404040;">
                                {{dect_count}}건
                            </div>
                        </div>

                    </div>

                </div>
            </div>
            <div class="row-6">
                <canvas id="today_dection"></canvas>
            </div>

            <div class="container3" style="display: block;">
            <canvas id="storage"></canvas>
            <canvas id="DB_storage"></canvas>
            <canvas id="CPU_usage"></canvas>
            <canvas id="network_traffic"></canvas>
            </div>

        </div>
    </div>

    <div class="col-6">
        <div class="row mt-1">
            <div class="chart-container" style=" height: 150px; width: 150px; margin-top: 50px;">
                <canvas id="network_traffic"></canvas>
            </div>

    <div class="container-fluid row-6">
        <div class="row-6"
            style="display: flex; overflow-y: scroll; width: auto; height: 300px; overflow-y:auto; overflow-x:hidden">
            <table class="table table-hover  caption-top mse-5 text-center">
                <caption id="dect-table-caption" style="font-size: 18px;">미처리 탐지건수({{dect_count}}건)</caption>
                <thead style="background-color: #3B82F6; color: #ffffff; font-size: 14px;">
                    <tr>
                        <th>번호</th>
                        <th>날짜</th>
                        <th>IP</th>
                        <th>이름</th>
                        <th>부서</th>
                        <th>비고</th>
                    </tr>
                </thead>
                <tbody id="dect-table-body">
                    {% for dection in dection_list %}
                    <tr>
                        <td>{{dection.dect_no}}</td>
                        <td>{{dection.create_at}}</td>
                        <td>{{dection.ip}}</td>
                        <td>{{dection.emp_no__emp_name}}</td>
                        <td>{{dection.emp_no__depmt_no__depmt_name}}</td>
                        <td><button class="btn btn-outline-primary" onclick="process({{dection.dect_no}});"> 처리하기
                            </button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

  
    <div class="container-fluid row-12">
        <div class="row-4"
            style="display: flex; overflow-y: scroll; width: auto; height:300px; overflow-y:auto; overflow-x:hidden">
            <table class="table table-hover  caption-top mse-5 text-center">
                <caption id="report-table-caption" style="font-size: 18px;">미처리 사유서({{report_count}}건)</caption>
                <thead style="background-color: #3B82F6; color: #ffffff; font-size: 14px;">
                    <tr>
                        <th>번호</th>
                        <th>날짜</th>
                        <th>IP</th>
                        <th>이름</th>
                        <th>부서</th>
                        <th>상태</th>
                        <th>비고</th>
                    </tr>
                    </thread>

                <tbody id="report-table-body">
                    {% for report in report_list %}
                    <tr>
                        <td>{{report.dect_no}}</td>
                        <td>{{report.create_at}}</td>
                        <td>{{report.ip}}</td>
                        <td>{{report.dect_no__emp_no__emp_name}}</td>
                        <td>{{report.dect_no__emp_no__depmt_no__depmt_name}}</td>
                        <td>미처리</td>
                        <td><button class="btn btn-outline-primary" onclick="process(dection.dect_no);">처리하기</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



</div>












{% endblock content %}